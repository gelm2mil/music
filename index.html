<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GELM â€“ MÃºsica Variada</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00ffe6" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <div class="page-bg">
    <div class="player-card">

      <!-- Cabecera tipo BBC con logo -->
      <div class="card-header">
        <div class="logo-wrap">
          <!-- tu logo -->
          <img src="icons/icon-512.png" alt="GELM" class="logo-img">
        </div>
        <div class="header-text">
          <div class="station-name">MÃºsica Variada</div>
          <div class="station-meta">
            <span class="live-dot"></span>
            LIVE Â· BY GELM
          </div>
        </div>
      </div>

      <!-- Portada / logo grande de la canciÃ³n -->
      <div class="hero-art">
        <img src="icons/icon-512.png" alt="Portada" id="current-art">
      </div>

      <!-- Info de la canciÃ³n actual -->
      <div class="now-playing">
        <div id="current-title" class="track-title">Selecciona una canciÃ³nâ€¦</div>
      </div>

      <!-- Controles principales -->
      <div class="controls-row">
        <button id="play-btn" class="ctrl-btn main-play">â–¶</button>
        <button id="vol-btn" class="ctrl-btn">ðŸ”Š</button>
        <button id="next-btn" class="ctrl-btn">â˜°</button>
      </div>

      <!-- Barra de progreso -->
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <div class="time-row">
        <span id="time-current">00:00</span>
        <span id="time-total">00:00</span>
      </div>

      <!-- Lista de canciones -->
      <div class="list-header">Lista de canciones</div>
      <div id="track-list" class="track-list">
        <!-- aquÃ­ se llena con JS -->
      </div>

      <!-- Audio oculto -->
      <audio id="audio"></audio>

      <!-- Pie -->
      <div class="footer">
        2000 - 2040 Â· BIENVENIDOS Â· nerox2mil@proton.me<br>
        att: ---[terry]---
      </div>
    </div>
  </div>

  <script>
  // ==========================
  // Utilidades
  // ==========================
  const fmt = t => {
    if (!t || isNaN(t)) return "00:00";
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  };

  // ==========================
  // Elementos
  // ==========================
  const audio       = document.getElementById("audio");
  const playBtn     = document.getElementById("play-btn");
  const volBtn      = document.getElementById("vol-btn");
  const nextBtn     = document.getElementById("next-btn");
  const trackListEl = document.getElementById("track-list");
  const currentTitle= document.getElementById("current-title");
  const currentArt  = document.getElementById("current-art");
  const progFill    = document.getElementById("progress-fill");
  const timeCurEl   = document.getElementById("time-current");
  const timeTotEl   = document.getElementById("time-total");

  let tracks = [];
  let currentIndex = -1;
  let userEverPlayed = false;

  // ==========================
  // Cargar lista desde musica.json
  // Formato esperado: [{ "url": "...", "title": "..." }, ...]
  // Si no hay title se usa nombre.
  // ==========================
  fetch("musica.json")
    .then(r => r.json())
    .then(data => {
      tracks = data.map((t, i) => ({
        url: t.url,
        title: (t.title || t.nombre || ("Pista " + (i+1))).trim()
      }));
      renderTrackList();
      // Dejar preparada la primera pero SIN reproducir (modo manual)
      if (tracks.length > 0) {
        setCurrentTrack(0, false);
      }
    })
    .catch(err => {
      console.error("Error cargando musica.json", err);
      currentTitle.textContent = "Error cargando mÃºsica";
    });

  // ==========================
  // Renderizar lista visual
  // ==========================
  function renderTrackList(){
    trackListEl.innerHTML = "";
    tracks.forEach((t, i) => {
      const row = document.createElement("div");
      row.className = "track-item";
      row.dataset.index = i;

      row.innerHTML = `
        <div class="track-thumb">
          <img src="icons/icon-512.png" alt="GELM">
        </div>
        <div class="track-info">
          <div class="track-name">${t.title}</div>
        </div>
      `;
      row.addEventListener("click", () => {
        setCurrentTrack(i, true); // clic = reproducir
      });
      trackListEl.appendChild(row);
    });
    updateActiveRow();
  }

  function updateActiveRow(){
    const rows = trackListEl.querySelectorAll(".track-item");
    rows.forEach(r => r.classList.remove("active"));
    if (currentIndex >= 0 && rows[currentIndex]) {
      rows[currentIndex].classList.add("active");
    }
  }

  // ==========================
  // Seleccionar pista
  // ==========================
  function setCurrentTrack(index, autoplay){
    if (!tracks.length) return;
    currentIndex = (index + tracks.length) % tracks.length;
    const track = tracks[currentIndex];

    audio.src = track.url;
    currentTitle.textContent = track.title;
    currentArt.src = "icons/icon-512.png"; // mismo logo para todas
    updateActiveRow();

    if (autoplay) {
      audio.play().catch(()=>{});
      userEverPlayed = true;
      playBtn.textContent = "â¸";
    } else {
      playBtn.textContent = "â–¶";
    }
  }

  // ==========================
  // Controles
  // ==========================
  playBtn.addEventListener("click", () => {
    if (!tracks.length) return;

    // Si nunca ha sonado nada, arrancar la actual
    if (!userEverPlayed) {
      if (currentIndex < 0) setCurrentTrack(0, true);
      else {
        audio.play().catch(()=>{});
        playBtn.textContent = "â¸";
      }
      userEverPlayed = true;
      return;
    }

    if (audio.paused) {
      audio.play().catch(()=>{});
      playBtn.textContent = "â¸";
    } else {
      audio.pause();
      playBtn.textContent = "â–¶";
    }
  });

  nextBtn.addEventListener("click", () => {
    if (!tracks.length) return;
    if (currentIndex < 0) {
      setCurrentTrack(0, true);
    } else {
      setCurrentTrack(currentIndex + 1, true);
    }
  });

  volBtn.addEventListener("click", () => {
    audio.muted = !audio.muted;
    volBtn.textContent = audio.muted ? "ðŸ”ˆ" : "ðŸ”Š";
  });

  audio.addEventListener("ended", () => {
    // al terminar, pasa a la siguiente automÃ¡ticamente
    if (tracks.length > 0) {
      setCurrentTrack(currentIndex + 1, true);
    }
  });

  // ==========================
  // Progreso y tiempos
  // ==========================
  audio.addEventListener("timeupdate", () => {
    if (!audio.duration || isNaN(audio.duration)) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    progFill.style.width = pct + "%";
    timeCurEl.textContent = fmt(audio.currentTime);
    timeTotEl.textContent = fmt(audio.duration);
  });

  audio.addEventListener("loadedmetadata", () => {
    timeTotEl.textContent = fmt(audio.duration);
    timeCurEl.textContent = fmt(0);
    progFill.style.width = "0%";
  });

  // Click para adelantar en la barra
  document.querySelector(".progress-bar").addEventListener("click", (e) => {
    if (!audio.duration) return;
    const rect = e.currentTarget.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const ratio = x / rect.width;
    audio.currentTime = ratio * audio.duration;
  });

  // ==========================
  // Service Worker PWA
  // ==========================
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
  </script>
</body>
</html>
