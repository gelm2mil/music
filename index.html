<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GELM â€“ MÃºsica Variada</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00ffe6" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <div class="page-bg">
    <div class="player-card">

      <!-- Cabecera tipo BBC con logo -->
      <div class="card-header">
        <div class="logo-wrap">
          <!-- â¬…ï¸ AQUI SOLO AGREGAMOS EL ID -->
          <img id="logo-mini" src="icons/icon-512.png" alt="GELM" class="logo-img">
        </div>
        <div class="header-text">
          <div class="station-name">MÃºsica Variada</div>
          <div class="station-meta">
            <span class="live-dot"></span>
            LIVE Â· BY GELM
          </div>
        </div>
      </div>

      <!-- Portada -->
      <div class="hero-art">
        <img src="icons/icon-512.png" alt="Portada" id="current-art">
      </div>

      <!-- Info de la canciÃ³n -->
      <div class="now-playing">
        <div id="current-title" class="track-title">Selecciona una canciÃ³nâ€¦</div>
      </div>

      <!-- Controles + Shuffle -->
      <div class="controls-row">
        <button id="play-btn" class="ctrl-btn main-play">â–¶</button>
        <button id="vol-btn" class="ctrl-btn">ðŸ”Š</button>

        <!-- ðŸ”€ BOTÃ“N SHUFFLE -->
        <button id="shuffle-btn" class="ctrl-btn active">ðŸ”€</button>

        <button id="next-btn" class="ctrl-btn">â˜°</button>
      </div>

      <!-- Barra de progreso -->
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <div class="time-row">
        <span id="time-current">00:00</span>
        <span id="time-total">00:00</span>
      </div>

      <!-- Lista -->
      <div class="list-header">Lista de canciones</div>
      <div id="track-list" class="track-list"></div>

      <!-- Audio -->
      <audio id="audio"></audio>

      <!-- Pie -->
      <div class="footer">
        2000 - 2040 Â· BIENVENIDOS Â· nerox2mil@proton.me<br>
        att: ---[terry]---
      </div>
    </div>
  </div>

  <script>
  // ==========================
  // FORMATEO DE TIEMPO
  // ==========================
  const fmt = t => {
    if (!t || isNaN(t)) return "00:00";
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
  };

  // ==========================
  // ELEMENTOS
  // ==========================
  const audio       = document.getElementById("audio");
  const playBtn     = document.getElementById("play-btn");
  const volBtn      = document.getElementById("vol-btn");
  const nextBtn     = document.getElementById("next-btn");
  const shuffleBtn  = document.getElementById("shuffle-btn");
  const trackListEl = document.getElementById("track-list");
  const currentTitle= document.getElementById("current-title");
  const currentArt  = document.getElementById("current-art");
  const progFill    = document.getElementById("progress-fill");
  const timeCurEl   = document.getElementById("time-current");
  const timeTotEl   = document.getElementById("time-total");

  // â­ ELEMENTO DEL LOGO PARA EL EFECTO
  const gelmLogo = document.getElementById("logo-mini");

  let tracks = [];
  let currentIndex = -1;
  let userEverPlayed = false;
  let shuffleMode = true; // INICIO EN ALEATORIO

  shuffleBtn.classList.add("active");

  // ==========================
  // CARGAR LISTA
  // ==========================
  fetch("musica.json")
    .then(r => r.json())
    .then(data => {
      tracks = data.map((t, i) => ({
        url: t.url,
        title: (t.title || t.nombre || ("Pista " + (i+1))).trim()
      }));

      renderTrackList();

      if (tracks.length > 0) {
        if (shuffleMode) {
          currentIndex = getRandomIndex(true);
        } else {
          currentIndex = 0;
        }
        setCurrentTrack(currentIndex, false);
      }
    });

  // ==========================
  // LISTA VISUAL
  // ==========================
  function renderTrackList(){
    trackListEl.innerHTML = "";
    tracks.forEach((t, i) => {
      const row = document.createElement("div");
      row.className = "track-item";
      row.dataset.index = i;

      row.innerHTML = `
        <div class="track-thumb">
          <img src="icons/icon-512.png" alt="GELM">
        </div>
        <div class="track-info">
          <div class="track-name">${t.title}</div>
        </div>
      `;

      row.addEventListener("click", () => {
        setCurrentTrack(i, true);
      });

      trackListEl.appendChild(row);
    });
    updateActiveRow();
  }

  function updateActiveRow(){
    const rows = trackListEl.querySelectorAll(".track-item");
    rows.forEach(r => r.classList.remove("active"));
    if (currentIndex >= 0 && rows[currentIndex]) {
      rows[currentIndex].classList.add("active");
    }
  }

  // ==========================
  // FUNCIÃ“N ALEATORIA
  // ==========================
  function getRandomIndex(firstLoad = false){
    if (tracks.length <= 1) return 0;
    let newIndex = currentIndex;
    while (newIndex === currentIndex) {
      newIndex = Math.floor(Math.random() * tracks.length);
    }
    return newIndex;
  }

  // ==========================
  // CAMBIAR PISTA
  // ==========================
  function setCurrentTrack(index, autoplay){
    currentIndex = (index + tracks.length) % tracks.length;

    const track = tracks[currentIndex];
    audio.src = track.url;
    currentTitle.textContent = track.title;
    currentArt.src = "icons/icon-512.png";
    updateActiveRow();

    if (autoplay) {
      audio.play().catch(()=>{});
      userEverPlayed = true;
      playBtn.textContent = "â¸";
    } else {
      playBtn.textContent = "â–¶";
    }
  }

  // ==========================
  // BOTÃ“N PLAY
  // ==========================
  playBtn.addEventListener("click", () => {
    if (!tracks.length) return;

    if (!userEverPlayed) {
      audio.play().catch(()=>{});
      playBtn.textContent = "â¸";
      userEverPlayed = true;
      return;
    }

    if (audio.paused) {
      audio.play().catch(()=>{});
      playBtn.textContent = "â¸";
    } else {
      audio.pause();
      playBtn.textContent = "â–¶";
    }
  });

  // â­ EFECTO NEÃ“N EN LOGO
  audio.addEventListener("play", ()=> {
    gelmLogo.style.filter = "drop-shadow(0 0 12px #00eaff)";
  });

  audio.addEventListener("pause", ()=> {
    gelmLogo.style.filter = "none";
  });

  // ==========================
  // NEXT
  // ==========================
  nextBtn.addEventListener("click", () => {
    if (shuffleMode) {
      setCurrentTrack(getRandomIndex(), true);
    } else {
      setCurrentTrack(currentIndex + 1, true);
    }
  });

  // ==========================
  // SHUFFLE
  // ==========================
  shuffleBtn.addEventListener("click", () => {
    shuffleMode = !shuffleMode;
    shuffleBtn.classList.toggle("active");
    shuffleBtn.textContent = shuffleMode ? "ðŸ”€" : "âž¡ï¸";
  });

  // ==========================
  // VOLUMEN
  // ==========================
  volBtn.addEventListener("click", () => {
    audio.muted = !audio.muted;
    volBtn.textContent = audio.muted ? "ðŸ”ˆ" : "ðŸ”Š";
  });

  // ==========================
  // CUANDO TERMINA
  // ==========================
  audio.addEventListener("ended", () => {
    if (shuffleMode) {
      setCurrentTrack(getRandomIndex(), true);
    } else {
      setCurrentTrack(currentIndex + 1, true);
    }
  });

  // ==========================
  // PROGRESO
  // ==========================
  audio.addEventListener("timeupdate", () => {
    if (!audio.duration) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    progFill.style.width = pct + "%";
    timeCurEl.textContent = fmt(audio.currentTime);
    timeTotEl.textContent = fmt(audio.duration);
  });

  audio.addEventListener("loadedmetadata", () => {
    timeTotEl.textContent = fmt(audio.duration);
    timeCurEl.textContent = "00:00";
    progFill.style.width = "0%";
  });

  // ==========================
  // CLICK EN BARRA
  // ==========================
  document.querySelector(".progress-bar").addEventListener("click", (e) => {
    if (!audio.duration) return;
    const box = e.currentTarget.getBoundingClientRect();
    const pct = (e.clientX - box.left) / box.width;
    audio.currentTime = pct * audio.duration;
  });

  // ==========================
  // SERVICE WORKER
  // ==========================
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }
  </script>

</body>
</html>
