<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>GELM ‚Äì M√∫sica Variada</title>

<link rel="manifest" href="manifest.webmanifest" />
<meta name="theme-color" content="#00ffe6" />

<!-- üî• CSS externo para velocidad -->
<link rel="stylesheet" href="styles.css" />
</head>

<body>

<div class="contenedor">

  <div class="header">
      <div class="icon-circulo">GELM</div>
      <div class="titulo">M√öSICA VARIADA</div>
      <div class="icon-circulo">GELM</div>
  </div>

  <canvas id="canvas"></canvas>

  <div class="player-box">
      <audio id="audio" preload="auto"></audio>

      <div class="progress-container">
          <div class="progress" id="progress"></div>
      </div>

      <div class="botones">
        <button class="btn" id="prev">‚èÆ Anterior</button>
        <button class="btn" id="playbtn">‚èØ</button>
        <button class="btn" id="next">Siguiente ‚è≠</button>
        <button class="btn" id="shuffle">Shuffle: ON</button>
      </div>
  </div>

  <input id="buscador" placeholder="buscar canci√≥n..." />

  <div id="bend" class="bend">B E N D I C I D O<br><span class="dia">D √ç A</span></div>

  <div class="footer">
      2000 - 2040 | BIENVENIDOS | nerox2mil@proton.me<br>
      att: ---[terry]---
  </div>

</div>

<script>
// =====================
// CARGA JSON
// =====================
let canciones = [];
fetch("musica.json")
  .then(r => r.json())
  .then(data => { canciones = data; iniciar(); });

let audio = document.getElementById("audio");
let progress = document.getElementById("progress");
let playbtn = document.getElementById("playbtn");
let bend = document.getElementById("bend");

let index = 0;
let shuffle = true;

// =====================
// INICIAR
// =====================
function iniciar(){
  if(shuffle){ index = Math.floor(Math.random()*canciones.length); }
  cargarCancion();
}

// =====================
// CARGAR CANCI√ìN
// =====================
function cargarCancion(){
  let c = canciones[index];
  audio.src = c.url;
  audio.play();
}

// =====================
// BOTONES
// =====================
playbtn.onclick = ()=> audio.paused ? audio.play() : audio.pause();

document.getElementById("prev").onclick = ()=>{
  index = (index - 1 + canciones.length) % canciones.length;
  cargarCancion();
}

document.getElementById("next").onclick = ()=>{
  index = (index + 1) % canciones.length;
  cargarCancion();
}

document.getElementById("shuffle").onclick = ()=>{
  shuffle = !shuffle;
  document.getElementById("shuffle").innerText = "Shuffle: " + (shuffle?"ON":"OFF");
}

// =====================
// BENDICIDO D√çA = PLAY
// =====================
bend.onclick = ()=> playbtn.onclick();

audio.addEventListener("play", ()=> bend.classList.add("vibrar"));
audio.addEventListener("pause", ()=> bend.classList.remove("vibrar"));

// =====================
// PROGRESO
// =====================
audio.addEventListener("timeupdate", ()=>{
  progress.style.width = (audio.currentTime / audio.duration) * 100 + "%";
});

// =====================
// BUSCADOR
// =====================
document.getElementById("buscador").addEventListener("input", e=>{
  let t = e.target.value.toLowerCase();
  let pos = canciones.findIndex(x => x.nombre.toLowerCase().includes(t));
  if(pos>=0){ index = pos; cargarCancion(); }
});

// =====================
// VISUALIZER OPTIMIZADO
// =====================
let ctx = new AudioContext();
let src = ctx.createMediaElementSource(audio);
let anal = ctx.createAnalyser();
src.connect(anal);
anal.connect(ctx.destination);

anal.fftSize = 128;   // ‚ö° m√°s liviano que 256 = m√°s r√°pido en m√≥viles
let buffer = new Uint8Array(anal.frequencyBinCount);

let canvas = document.getElementById("canvas");
let c = canvas.getContext("2d");

function draw(){
  requestAnimationFrame(draw);
  anal.getByteFrequencyData(buffer);

  c.clearRect(0,0,canvas.width,canvas.height);

  let w = canvas.width / buffer.length;
  for(let i=0;i<buffer.length;i++){
    let h = buffer[i];
    c.fillStyle = `hsl(${i*5},100%,50%)`;
    c.fillRect(i*w, canvas.height - h, w-2, h);
  }
}
draw();

canvas.width = canvas.offsetWidth;
canvas.height = canvas.offsetHeight;

// =====================
// SERVICE WORKER
// =====================
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
