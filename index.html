<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GELM ¬∑ Reproductor Neon</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Colores del navegador -->
  <meta name="theme-color" content="#000000" />

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="page-wrap">
  <div class="center">

    <!-- T√çTULO / CABECERA -->
    <header class="header">
      üéß GELM ¬∑ M√∫sica Variada Neon
    </header>

    <!-- VISUALIZADOR -->
    <section class="eq-frame">
      <canvas id="viz"></canvas>
    </section>

    <!-- SUPERFICIE DEL PLAYER -->
    <section class="audio-wrap">
      <div class="player-surface" id="playerSurface">
        <!-- Icono ‚Äúbocina arcoiris‚Äù -->
        <div class="sound-orb">
          <div class="sound-orb-inner"></div>
        </div>

        <!-- Barra de progreso personalizada -->
        <div class="progress-wrap">
          <div id="progress" class="progress"></div>
        </div>

        <!-- Tiempo -->
        <div class="time" id="timeText">00:00 / 00:00</div>

        <!-- Controles -->
        <div class="controls-row">
          <button id="prev" class="btn">‚üµ Anterior</button>
          <button id="playPause" class="btn btn-main">‚ñ∂Ô∏é</button>
          <button id="next" class="btn">Siguiente ‚ü∂</button>
          <button id="shuffleBtn" class="btn btn-outline">Shuffle: ON</button>
        </div>

        <!-- Audio real (sin controles nativos) -->
        <audio id="audio" crossorigin="anonymous"></audio>
      </div>
    </section>

    <!-- SELECTOR DE CANCIONES -->
    <section>
      <select id="cancion" class="song-select" aria-label="Selecci√≥n de canciones">
        <option value="">[..:: ELIGE LA CANCI√ìN ::..]</option>
      </select>
    </section>

    <!-- FRASE INFERIOR ‚ÄúFUEGO‚Äù -->
    <section class="phrase-wrapper">
      <div id="phrase" class="phrase-box">
        BENDICIDO
        <div class="phrase-sub">D√çA</div>
      </div>
    </section>

    <!-- PIE -->
    <footer class="footer">
      2000 - 2040 | BIENVENIDOS | nerox2mil@proton.me<br>
      att: ---[terry]---
    </footer>

  </div>
</div>

<!-- CONTADOR NEROX (esquina) -->
<div id="contador">NEROX = 0</div>

<script>
/* ============ CONTADOR NEROX ============ */
async function contadorNerox() {
  try {
    const res = await fetch("https://api.countapi.xyz/hit/nerox/reproductor");
    const data = await res.json();
    const box = document.getElementById("contador");
    if (box) box.textContent = "NEROX = " + data.value;
  } catch (e) {
    console.log("Error contador", e);
  }
}
contadorNerox();

/* ============ BLOQUEO CLICK DERECHO ============ */
document.addEventListener('contextmenu', e => e.preventDefault());

/* ============ ELEMENTOS ============ */
const audio        = document.getElementById('audio');
const canvas       = document.getElementById('viz');
const ctx          = canvas.getContext('2d');
const progressEl   = document.getElementById('progress');
const timeText     = document.getElementById('timeText');
const select       = document.getElementById('cancion');
const phrase       = document.getElementById('phrase');
const prevBtn      = document.getElementById('prev');
const nextBtn      = document.getElementById('next');
const playPauseBtn = document.getElementById('playPause');
const shuffleBtn   = document.getElementById('shuffleBtn');
const playerSurface = document.getElementById('playerSurface');
const soundOrb      = document.querySelector('.sound-orb');

/* AudioContext / Visualizer */
let audioCtx = null, analyser = null, sourceNode = null,
    dataArray = null, bufferLength = 0, vizId = null;

/* Playlist */
let playlist = [];     // [{url,title}, ...]
let order = [];        // indices aleatorios
let currentOrderIndex = 0;
let shuffleOn = true;
let firstPlay = false;

/* Config visualizer */
const bars   = 96;
const layers = 6;

/* ============ CANVAS RESPONSIVE ============ */
function resizeCanvas(){
  const r = canvas.getBoundingClientRect();
  canvas.width  = Math.floor(r.width * devicePixelRatio);
  canvas.height = Math.floor(r.height * devicePixelRatio);
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

/* ============ FORMATO TIEMPO ============ */
function fmt(t){
  if(!t || isNaN(t)) return "00:00";
  const m = Math.floor(t/60);
  const s = Math.floor(t%60);
  return String(m).padStart(2,'0')+":"+String(s).padStart(2,'0');
}

/* ============ PROGRESO ============ */
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration && !isNaN(audio.duration)){
    const pct = (audio.currentTime / audio.duration) * 100;
    progressEl.style.width = pct + "%";
    progressEl.style.backgroundPosition = (audio.currentTime * 10 % 400) + "% 0%";
    timeText.textContent = fmt(audio.currentTime) + " / " + fmt(audio.duration);
  } else {
    timeText.textContent = "00:00 / 00:00";
  }
});

/* SEEK con click en barra */
document.querySelector('.progress-wrap').addEventListener('click', e=>{
  if(!audio.duration) return;
  const rect = e.currentTarget.getBoundingClientRect();
  const x = e.clientX - rect.left;
  audio.currentTime = (x / rect.width) * audio.duration;
});

/* ============ CONTROLES ============ */
playPauseBtn.addEventListener('click', ()=>{
  if(audio.paused) audio.play().catch(()=>{}); else audio.pause();
});

prevBtn.addEventListener('click', prevSong);
nextBtn.addEventListener('click', nextSong);

shuffleBtn.addEventListener('click', ()=>{
  shuffleOn = !shuffleOn;
  shuffleBtn.textContent = shuffleOn ? 'Shuffle: ON' : 'Shuffle: OFF';
  if(playlist.length){
    const currentIdx = order[currentOrderIndex] ?? 0;
    buildOrderWithStart(currentIdx);
  }
});

select.addEventListener('change', function(){
  if(!this.value) return;
  const idx = parseInt(this.value,10);
  buildOrderWithStart(idx);
  currentOrderIndex = 0;
  playCurrentOrder();
});

/* Barra espaciadora = play/pause */
document.addEventListener('keydown', e=>{
  if(e.code === 'Space'){
    e.preventDefault();
    if(audio.paused) audio.play().catch(()=>{}); else audio.pause();
  }
});

/* Click en superficie negra = play/pause */
playerSurface.addEventListener('click', e=>{
  if(e.target.tagName.toLowerCase() === 'button' ||
     e.target.tagName.toLowerCase() === 'select') return;
  if(audio.paused) audio.play().catch(()=>{}); else audio.pause();
});

/* Actualizar icono play/pause y animaci√≥n orb */
audio.addEventListener('play', ()=>{
  playPauseBtn.textContent = '‚è∏';
  soundOrb.classList.add('sound-orb-on');
});
audio.addEventListener('pause', ()=>{
  playPauseBtn.textContent = '‚ñ∂Ô∏é';
  soundOrb.classList.remove('sound-orb-on');
});

/* Auto siguiente */
audio.addEventListener('ended', nextSong);

/* ============ AUDIOCONTEXT / VIZ ============ */
function createGraph(){
  if(audioCtx) return true;
  try{
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    sourceNode = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    return true;
  }catch(e){
    console.warn("AudioContext creation failed:", e);
    return false;
  }
}

/* Iniciar visualizador la primera vez que se reproduce */
audio.addEventListener('play', () => {
  if(!firstPlay){
    const ok = createGraph();
    if(ok) startViz();
    document.documentElement.style.setProperty('--pulse','1.2');
    setTimeout(()=> document.documentElement.style.setProperty('--pulse','1'), 600);
    firstPlay = true;
  }
});

/* Dibujo del visualizador */
function startViz(){
  if(!analyser) return;
  cancelAnimationFrame(vizId);

  function draw(){
    analyser.getByteFrequencyData(dataArray);

    const rect = canvas.getBoundingClientRect();
    const W = rect.width;
    const H = rect.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    /* Promedio para pulso general */
    let sum = 0;
    for(let i=0;i<dataArray.length;i++) sum += dataArray[i];
    const avg = sum / dataArray.length / 255;
    document.documentElement.style.setProperty('--pulse', (0.6 + avg*1.4).toFixed(3));

    const gap = 2;
    const barW = Math.max(1, (W / bars) - gap);

    for(let layer=0; layer<layers; layer++){
      const depth = layer / layers;
      const scale = 1 - depth * 0.5;
      const alpha = 0.18 + (1 - depth) * 0.6;
      const yOffset = layer * (H * 0.02);

      for(let i=0;i<bars;i++){
        const idx = Math.floor(i * bufferLength / bars);
        const v = dataArray[idx] / 255;
        const h = Math.max(2, v * H * 0.78 * scale);
        const x = i * (barW + gap) + layer * 4;
        const y = H - h - yOffset;

        const pos = i / bars;
        let color;
        if(pos < 0.2)      color = lerpColor([255,40,60],[255,210,30], pos/0.2);
        else if(pos < 0.45)color = lerpColor([255,210,30],[166,77,255], (pos-0.2)/0.25);
        else if(pos < 0.7) color = lerpColor([166,77,255],[0,68,255], (pos-0.45)/0.25);
        else               color = lerpColor([0,68,255],[0,255,120], (pos-0.7)/0.3);

        ctx.fillStyle = `rgba(${color[0]},${color[1]},${color[2]},${alpha})`;
        ctx.shadowBlur  = 24 * (1 - depth) * (1 + avg*1.6);
        ctx.shadowColor = `rgba(${color[0]},${Math.max(40,color[1])},${color[2]},${0.45*(1-depth)})`;
        ctx.fillRect(x, y, barW*0.82, h);
        ctx.shadowBlur = 0;
      }
    }

    vizId = requestAnimationFrame(draw);
  }
  draw();
}

function lerpColor(a,b,t){
  return [
    Math.round(a[0] + (b[0]-a[0])*t),
    Math.round(a[1] + (b[1]-a[1])*t),
    Math.round(a[2] + (b[2]-a[2])*t)
  ];
}

/* ============ EFECTO FUEGO EN FRASE ============ */
(function flameLoop(){
  let pulse = 0;
  function frame(){
    if(analyser && dataArray){
      analyser.getByteFrequencyData(dataArray);
      let sum = 0;
      for(let i=0;i<dataArray.length;i++) sum += dataArray[i];
      let avg = sum / dataArray.length / 255;
      const intensity = 6 + Math.min(72, Math.floor(avg * 140));
      phrase.style.textShadow =
        `0 0 ${intensity}px rgba(255,80,30,0.98),
         0 0 ${intensity*1.4}px rgba(255,40,30,0.6)`;
      phrase.style.transform = `translateY(${Math.min(14,Math.floor(avg*28))}px)`;
      phrase.style.letterSpacing = (6 + Math.round(avg * 6)) + "px";
    } else {
      pulse += 0.03;
      const p = (Math.sin(pulse) + 1) / 2;
      const intensity = 6 + Math.round(12 * p);
      phrase.style.textShadow =
        `0 0 ${intensity}px rgba(255,80,30,0.9),
         0 0 ${intensity*1.3}px rgba(255,40,30,0.5)`;
      phrase.style.transform = `translateY(${Math.round(4 * p)}px)`;
    }
    requestAnimationFrame(frame);
  }
  frame();
})();

/* ============ PLAYLIST / ORDEN ============ */
function buildSelect(){
  select.innerHTML = '<option value="">[..:: ELIGE LA CANCI√ìN ::..]</option>';
  playlist.forEach((s,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = s.title;
    select.appendChild(o);
  });
}

function shuffleArray(a){
  const arr = a.slice();
  for(let i = arr.length -1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

/* Construir orden: preferir canci√≥n que contenga "ger" */
function buildOrderWithStart(startIndex){
  if(playlist.length===0) return;

  let forcedStart = (typeof startIndex === 'number') ? startIndex : null;

  if(forcedStart === null){
    const idx = playlist.findIndex(p =>
      p.title && p.title.toLowerCase().includes('ger')
    );
    forcedStart = (idx !== -1) ? idx : 0;
  }

  const others = [];
  for(let i=0;i<playlist.length;i++){
    if(i!==forcedStart) others.push(i);
  }
  const orderedOthers = shuffleOn ? shuffleArray(others) : others;
  order = [forcedStart, ...orderedOthers];

  if(typeof startIndex === 'number' && startIndex !== forcedStart){
    const pool = [];
    for(let i=0;i<playlist.length;i++) if(i!==startIndex) pool.push(i);
    const rest = shuffleOn ? shuffleArray(pool) : pool;
    order = [startIndex, ...rest];
  }
  currentOrderIndex = 0;
}

function playCurrentOrder(){
  if(!order.length) return;
  const playlistIdx = order[currentOrderIndex];
  const item = playlist[playlistIdx];
  if(!item) return;

  audio.src = item.url;
  audio.load();
  audio.play().catch(()=>{});
  select.value = playlistIdx;
}

function nextSong(){
  if(!order.length) return;
  currentOrderIndex++;
  if(currentOrderIndex >= order.length){
    buildOrderWithStart();
    currentOrderIndex = 0;
  }
  playCurrentOrder();
}

function prevSong(){
  if(!order.length) return;
  currentOrderIndex--;
  if(currentOrderIndex < 0) currentOrderIndex = order.length - 1;
  playCurrentOrder();
}

/* ============ CARGAR MUSICA.JSON ============ */
async function loadSongsFromJSON(){
  try{
    // IMPORTANTE: ruta relativa al propio repo GitHub
    const resp = await fetch('./musica.json', { cache: 'no-cache' });
    const data = await resp.json();

    playlist = data.map(d => ({
      url:   d.url,
      title: (d.title || '').trim()
    }));

    if(!playlist.length) return;

    buildSelect();
    buildOrderWithStart();   // arranca en "ger" si existe
    playCurrentOrder();      // intenta reproducir al entrar (seg√∫n permisos del navegador)
  }catch(e){
    console.error('Error cargando musica.json', e);
  }
}

/* ============ SERVICE WORKER (PWA) ============ */
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker
      .register('./service-worker.js')
      .catch(err => console.log('SW error', err));
  });
}

/* INICIO */
loadSongsFromJSON();
</script>
</body>
</html>
