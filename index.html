<script>
/* =========================================
      CONFIG PRINCIPAL (SIN CONTADOR)
========================================= */

// Elementos
const audio        = document.getElementById('audio');
const canvas       = document.getElementById('viz');
const ctx          = canvas.getContext('2d');
const progressEl   = document.getElementById('progress');
const timeText     = document.getElementById('timeText');
const select       = document.getElementById('cancion');
const prevBtn      = document.getElementById('prev');
const nextBtn      = document.getElementById('next');
const playPauseBtn = document.getElementById('playPause');
const shuffleBtn   = document.getElementById('shuffleBtn');

// Visualizer
let audioCtx = null, analyser = null, sourceNode = null;
let dataArray = null, bufferLength = 0, vizId = null;

// Playlist
let playlist = [];
let order = [];
let currentOrderIndex = 0;
let shuffleOn = true;
let firstPlay = false;

// ========================
//  CARGAR JSON (REVISADO)
// ========================
async function loadSongsFromJSON(){
  try{
    const resp = await fetch('./musica.json', { cache: 'no-cache' });
    const data = await resp.json();

    playlist = data.map(d => ({ url: d.url, title: d.title }));

    if(!playlist.length) return;

    buildSelect();

    // Crear orden aleatorio desde el inicio
    buildOrderWithStart();

    // No puede reproducir automáticamente, pero deja lista la canción 1
    audio.src = playlist[order[0]].url;
    select.value = order[0];

  }catch(e){
    console.error("Error cargando JSON", e);
  }
}

// ===============================
//      CONSTRUIR SELECT
// ===============================
function buildSelect(){
  select.innerHTML = '<option value="">[..:: ELIGE LA CANCIÓN ::..]</option>';
  playlist.forEach((s,i)=>{
    const o = document.createElement('option');
    o.value = i;
    o.textContent = s.title;
    select.appendChild(o);
  });
}

// ===============================
//    SHUFFLE DE TODA LA VIDA
// ===============================
function shuffleArray(a){
  const arr = a.slice();
  for(let i = arr.length -1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function buildOrderWithStart(){
  const base = playlist.map((_,i)=>i);
  order = shuffleArray(base);
  currentOrderIndex = 0;
}

// ===============================
//    CONTROL DE REPRODUCCIÓN
// ===============================
function playCurrent(){
  const idx = order[currentOrderIndex];
  audio.src = playlist[idx].url;
  audio.play().catch(()=>{});
}

nextBtn.addEventListener('click', ()=>{
  currentOrderIndex++;
  if(currentOrderIndex >= order.length){
    buildOrderWithStart();
    currentOrderIndex = 0;
  }
  playCurrent();
});

prevBtn.addEventListener('click', ()=>{
  currentOrderIndex--;
  if(currentOrderIndex < 0) currentOrderIndex = order.length - 1;
  playCurrent();
});

// Selector
select.addEventListener('change', function(){
  const idx = parseInt(this.value,10);
  if(isNaN(idx)) return;
  audio.src = playlist[idx].url;
  audio.play().catch(()=>{});
});

// Play/Pause
playPauseBtn.addEventListener('click', ()=>{
  if(audio.paused) audio.play().catch(()=>{}); 
  else audio.pause();
});

// ===============================
//   PRIMER CLICK = ARRANCAR TODO
// ===============================
document.addEventListener('click', ()=>{

  if(firstPlay) return;
  firstPlay = true;

  // Reproducir inmediatamente
  playCurrent();

}, { once:true });

// ===============================
//      PROGRESO DEL AUDIO
// ===============================
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration){
    progressEl.style.width = ((audio.currentTime / audio.duration)*100) + "%";
    timeText.textContent =
      new Date(audio.currentTime*1000).toISOString().substr(14,5) +
      " / " +
      new Date(audio.duration*1000).toISOString().substr(14,5);
  }
});

// ===============================
//   SIGUIENTE AUTOMÁTICO
// ===============================
audio.addEventListener('ended', ()=>{
  nextBtn.click();
});

// ===============================
// INICIAR
// ===============================
loadSongsFromJSON();

</script>
