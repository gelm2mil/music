<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GELM ‚Äì M√∫sica Variada</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00ffe6" />

  <!-- ESTILOS -->
  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="splash.css" />
</head>

<body>

<!-- ================================
     SPLASH ULTRA NE√ìN
================================ -->
<div id="splash" class="splash-bg">
  <img src="icons/icon-512.png" class="splash-logo">
</div>

<!-- ================================
     PLAYER PRINCIPAL
================================ -->
<div class="page-bg">
  <div class="player-card">

    <!-- CABECERA -->
    <div class="card-header">

      <!-- LOGO CON EFECTOS -->
      <div class="logo-wrap" style="position:relative;">
        <img id="logo-mini" src="icons/icon-192.png" class="logo-img" alt="GELM">
      </div>

      <div class="header-text">
        <div class="station-name">M√∫sica Variada</div>
        <div class="station-meta">
          <span class="live-dot"></span>
          LIVE ¬∑ BY GELM
        </div>
      </div>
    </div>

    <!-- PORTADA -->
    <div class="hero-art">
      <img src="icons/icon-512.png" id="current-art" alt="Portada">
    </div>

    <!-- T√çTULO -->
    <div class="now-playing">
      <div id="current-title">Selecciona una canci√≥n‚Ä¶</div>
    </div>

    <!-- CONTROLES -->
    <div class="controls-row">
      <button id="play-btn" class="ctrl-btn">‚ñ∂</button>
      <button id="vol-btn" class="ctrl-btn">üîä</button>
      <button id="shuffle-btn" class="ctrl-btn active">üîÄ</button>
      <button id="next-btn" class="ctrl-btn">‚ò∞</button>
    </div>

    <!-- PROGRESO -->
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill"></div>
    </div>

    <div class="time-row">
      <span id="time-current">00:00</span>
      <span id="time-total">00:00</span>
    </div>

    <!-- LISTA -->
    <div class="list-header">Lista de canciones</div>
    <div id="track-list" class="track-list"></div>

    <!-- AUDIO -->
    <audio id="audio"></audio>

    <!-- PIE -->
    <div class="footer">
      2000 - 2040 ¬∑ BIENVENIDOS ¬∑ nerox2mil@proton.me<br>
      att: ---[terry]---
    </div>

  </div>
</div>

<!-- ================================
        SCRIPT DEL PLAYER
================================ -->
<script>
// ==========================
// FORMATO DE TIEMPO
// ==========================
const fmt = t => {
  if (!t || isNaN(t)) return "00:00";
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60);
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
};

// ==========================
// ELEMENTOS
// ==========================
const audio        = document.getElementById("audio");
const playBtn      = document.getElementById("play-btn");
const volBtn       = document.getElementById("vol-btn");
const nextBtn      = document.getElementById("next-btn");
const shuffleBtn   = document.getElementById("shuffle-btn");
const trackListEl  = document.getElementById("track-list");
const currentTitle = document.getElementById("current-title");
const currentArt   = document.getElementById("current-art");
const progFill     = document.getElementById("progress-fill");
const timeCurEl    = document.getElementById("time-current");
const timeTotEl    = document.getElementById("time-total");
const gelmLogo     = document.getElementById("logo-mini");

let tracks = [];
let currentIndex = -1;
let shuffleMode = true;
let userEverPlayed = false;

// ==========================
// CARGA DE LISTA (CON CATEGOR√çAS)
// ==========================
fetch("musica.json")
  .then(r => r.json())
  .then(data => {
    tracks = data; 
    renderTrackList();
    currentIndex = shuffleMode ? getRandomSongIndex() : 0;
    setCurrentTrack(currentIndex, false);
  });

// ==========================
// LISTA VISUAL
// ==========================
function renderTrackList() {
  trackListEl.innerHTML = "";

  tracks.forEach((t, i) => {

    // CATEGOR√çAS
    if (t.category) {
      const cat = document.createElement("div");
      cat.className = "category-banner";
      cat.textContent = t.category;
      trackListEl.appendChild(cat);
      return;
    }

    // CANCIONES
    const row = document.createElement("div");
    row.className = "track-item";
    row.dataset.index = i;

    row.innerHTML = `
      <div class="track-thumb">
        <img src="icons/icon-192.png">
      </div>
      <div class="track-info">
        <div class="track-name">${t.title}</div>
      </div>
    `;

    row.addEventListener("click", () => setCurrentTrack(i, true));
    trackListEl.appendChild(row);
  });

  updateActiveRow();
}

// ==========================
// MARCAR ACTIVA
// ==========================
function updateActiveRow() {
  const rows = trackListEl.querySelectorAll(".track-item");
  rows.forEach(r => r.classList.remove("active"));
  const active = rows[currentIndex];
  if (active) active.classList.add("active");
}

// ==========================
// OBTENER √çNDICE ALEATORIO SOLO DE CANCIONES
// ==========================
function getRandomSongIndex() {
  let r = currentIndex;
  while (!tracks[r] || tracks[r].category || r === currentIndex) {
    r = Math.floor(Math.random() * tracks.length);
  }
  return r;
}

// ==========================
// CAMBIAR PISTA
// ==========================
function setCurrentTrack(i, autoplay) {
  currentIndex = i;

  const track = tracks[currentIndex];
  audio.src = track.url;
  currentTitle.textContent = track.title;

  updateActiveRow();

  if (autoplay) {
    audio.play();
    playBtn.textContent = "‚è∏";
    userEverPlayed = true;
    gelmLogo.classList.add("logo-pulse");
  } else {
    playBtn.textContent = "‚ñ∂";
  }
}

// ==========================
// CONTROLES DE AUDIO
// ==========================
playBtn.addEventListener("click", () => {
  if (audio.paused) {
    audio.play();
    playBtn.textContent = "‚è∏";
    gelmLogo.classList.add("logo-pulse");
  } else {
    audio.pause();
    playBtn.textContent = "‚ñ∂";
    gelmLogo.classList.remove("logo-pulse");
  }
});

// SIGUIENTE
nextBtn.addEventListener("click", () => {
  const next = shuffleMode ? getRandomSongIndex() : currentIndex + 1;
  setCurrentTrack(next, true);
});

// SHUFFLE
shuffleBtn.addEventListener("click", () => {
  shuffleMode = !shuffleMode;
  shuffleBtn.classList.toggle("active");
  shuffleBtn.textContent = shuffleMode ? "üîÄ" : "‚û°Ô∏è";
});

// MUTE
volBtn.addEventListener("click", () => {
  audio.muted = !audio.muted;
  volBtn.textContent = audio.muted ? "üîà" : "üîä";
});

// AL TERMINAR
audio.addEventListener("ended", () => {
  const next = shuffleMode ? getRandomSongIndex() : currentIndex + 1;
  setCurrentTrack(next, true);
});

// PROGRESO
audio.addEventListener("timeupdate", () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  progFill.style.width = pct + "%";
  timeCurEl.textContent = fmt(audio.currentTime);
  timeTotEl.textContent = fmt(audio.duration);
});

// CLICK BARRA
document.querySelector(".progress-bar").addEventListener("click", e => {
  const box = e.currentTarget.getBoundingClientRect();
  const pct = (e.clientX - box.left) / box.width;
  audio.currentTime = pct * audio.duration;
});

// ==========================
// OCULTAR SPLASH ULTRA NE√ìN
// ==========================
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    document.getElementById("splash").classList.add("splash-hide");
  }, 900);
});

// ==========================
// SERVICE WORKER
// ==========================
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
