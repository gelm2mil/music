<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GELM ¬∑ Reproductor Neon</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="manifest.webmanifest">

  <!-- Colores del navegador -->
  <meta name="theme-color" content="#000000" />

  <!-- Estilos -->
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="page-wrap">
  <div class="center">

    <!-- T√çTULO / CABECERA -->
    <header class="header">
      üéß GELM ¬∑ M√∫sica Variada Neon
    </header>

    <!-- VISUALIZADOR -->
    <section class="eq-frame">
      <canvas id="viz"></canvas>
    </section>

    <!-- SUPERFICIE DEL PLAYER -->
    <section class="audio-wrap">
      <div class="player-surface" id="playerSurface">

        <!-- Icono ‚Äúbocina arcoiris‚Äù -->
        <div class="sound-orb">
          <div class="sound-orb-inner"></div>
        </div>

        <!-- Barra de progreso -->
        <div class="progress-wrap">
          <div id="progress" class="progress"></div>
        </div>

        <!-- Tiempo -->
        <div class="time" id="timeText">00:00 / 00:00</div>

        <!-- Controles -->
        <div class="controls-row">
          <button id="prev" class="btn">‚üµ Anterior</button>
          <button id="playPause" class="btn btn-main">‚ñ∂Ô∏é</button>
          <button id="next" class="btn">Siguiente ‚ü∂</button>
          <button id="shuffleBtn" class="btn btn-outline">Shuffle: ON</button>
        </div>

        <audio id="audio" crossorigin="anonymous"></audio>
      </div>
    </section>

    <!-- SELECTOR DE CANCIONES -->
    <section>
      <select id="cancion" class="song-select">
        <option value="">[..:: ELIGE LA CANCI√ìN ::..]</option>
      </select>
    </section>

    <!-- FRASE -->
    <section class="phrase-wrapper">
      <div id="phrase" class="phrase-box">
        BENDICIDO
        <div class="phrase-sub">D√çA</div>
      </div>
    </section>

    <!-- PIE -->
    <footer class="footer">
      2000 - 2040 | BIENVENIDOS | nerox2mil@proton.me<br>
      att: ---[terry]---
    </footer>

  </div>
</div>

<!-- CONTADOR NEROX -->
<div id="contador">NEROX = 0</div>

<script>
/* ================= CONTADOR NEROX ================= */
async function contadorNerox() {
  try {
    const res = await fetch("https://api.countapi.xyz/hit/nerox/reproductor");
    const data = await res.json();
    document.getElementById("contador").textContent = "NEROX = " + data.value;
  } catch(e){}
}
contadorNerox();

/* ================= VARIABLES ================= */
const audio = document.getElementById("audio");
const canvas = document.getElementById("viz");
const ctx = canvas.getContext("2d");
const progressEl = document.getElementById("progress");
const timeText = document.getElementById("timeText");
const select = document.getElementById("cancion");
const phrase = document.getElementById("phrase");

/* Visualizer */
let audioCtx = null, analyser = null, sourceNode = null, dataArray = null;

/* Playlist */
let playlist = [];
let order = [];
let currentOrderIndex = 0;
let shuffleOn = true;

/* ================= CARGAR PLAYLIST ================= */
async function loadSongsFromJSON(){
  try{
    const resp = await fetch("./musica.json?" + Date.now());
    const data = await resp.json();

    playlist = data.map(d => ({
      url: d.url,
      title: (d.title || "").trim()
    }));

    buildSelect();
    buildOrderWithStart();
    playCurrentOrder();
  }catch(err){
    console.error("musica.json ERROR", err);
  }
}

function buildSelect(){
  select.innerHTML = '<option value="">[..:: ELIGE LA CANCI√ìN ::..]</option>';
  playlist.forEach((s,i)=>{
    const o = document.createElement("option");
    o.value = i;
    o.textContent = s.title;
    select.appendChild(o);
  });
}

function buildOrderWithStart(startIndex){
  if(playlist.length===0) return;

  let forced = startIndex ?? playlist.findIndex(x =>
    x.title.toLowerCase().includes("ger")
  );

  if(forced < 0) forced = 0;

  let others = playlist.map((_,i)=>i).filter(i=>i!==forced);
  if(shuffleOn) others = shuffleArray(others);

  order = [forced, ...others];
  currentOrderIndex = 0;
}

function shuffleArray(arr){
  return arr.sort(()=>Math.random()-0.5);
}

select.addEventListener("change", ()=>{
  if(!select.value) return;
  buildOrderWithStart(parseInt(select.value));
  playCurrentOrder();
});

/* ================= CONTROLES ================= */
document.getElementById("playPause").onclick = ()=>{
  audio.paused ? audio.play() : audio.pause();
};
document.getElementById("next").onclick = nextSong;
document.getElementById("prev").onclick = prevSong;

function nextSong(){
  currentOrderIndex++;
  if(currentOrderIndex >= order.length){
    buildOrderWithStart();
    currentOrderIndex = 0;
  }
  playCurrentOrder();
}

function prevSong(){
  currentOrderIndex--;
  if(currentOrderIndex < 0) currentOrderIndex = order.length - 1;
  playCurrentOrder();
}

function playCurrentOrder(){
  const idx = order[currentOrderIndex];
  const song = playlist[idx];
  audio.src = song.url;
  select.value = idx;
  audio.play();
}

/* ================= VISUALIZER ================= */
audio.addEventListener("play", ()=>{
  if(!audioCtx){
    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    sourceNode = audioCtx.createMediaElementSource(audio);
    sourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    renderViz();
  }
});

function renderViz(){
  requestAnimationFrame(renderViz);
  analyser.getByteFrequencyData(dataArray);

  const W = canvas.width = canvas.clientWidth;
  const H = canvas.height = canvas.clientHeight;

  ctx.clearRect(0,0,W,H);
  const barWidth = W / 96;

  for(let i=0;i<96;i++){
    const v = dataArray[i] / 255;
    const h = v * H * 0.9;
    ctx.fillStyle = `hsl(${i*3},100%,50%)`;
    ctx.fillRect(i*barWidth, H-h, barWidth-2, h);
  }
}

/* ================= SW ================= */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./service-worker.js");
}

loadSongsFromJSON();
</script>

</body>
</html>
