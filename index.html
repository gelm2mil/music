<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GELM â€“ MÃºsica Variada</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#00ffe6" />

  <link rel="stylesheet" href="styles.css" />
  <link rel="stylesheet" href="splash.css" />
</head>

<body>

<!-- ================================
     SPLASH RÃPIDO
================================ -->
<div id="splash" class="splash-bg">
  <img src="icons/icon-512.png" class="splash-logo">
</div>

<!-- ================================
     PLAYER MAIN
================================ -->
<div class="page-bg">
  <div class="player-card">

    <!-- Cabecera -->
    <div class="card-header">
      <div class="logo-wrap">
        <img id="logo-mini" src="icons/icon-512.png" alt="GELM" class="logo-img">
      </div>
      <div class="header-text">
        <div class="station-name">MÃºsica Variada</div>
        <div class="station-meta">
          <span class="live-dot"></span>
          LIVE Â· BY GELM
        </div>
      </div>
    </div>

    <!-- Portada -->
    <div class="hero-art">
      <img src="icons/icon-512.png" id="current-art">
    </div>

    <!-- TÃ­tulo canciÃ³n -->
    <div class="now-playing">
      <div id="current-title">Selecciona una canciÃ³nâ€¦</div>
    </div>

    <!-- Controles -->
    <div class="controls-row">
      <button id="play-btn" class="ctrl-btn">â–¶</button>
      <button id="vol-btn" class="ctrl-btn">ðŸ”Š</button>
      <button id="shuffle-btn" class="ctrl-btn active">ðŸ”€</button>
      <button id="next-btn" class="ctrl-btn">â˜°</button>
    </div>

    <!-- Barra progreso -->
    <div class="progress-bar">
      <div id="progress-fill" class="progress-fill"></div>
    </div>

    <div class="time-row">
      <span id="time-current">00:00</span>
      <span id="time-total">00:00</span>
    </div>

    <!-- Lista -->
    <div class="list-header">Lista de canciones</div>
    <div id="track-list" class="track-list"></div>

    <audio id="audio"></audio>

    <div class="footer">
      2000 - 2040 Â· BIENVENIDOS Â· nerox2mil@proton.me<br>
      att: ---[terry]---
    </div>
  </div>
</div>

<!-- ================================
     SCRIPT PLAYER
================================ -->
<script>
const fmt = t => {
  if (!t || isNaN(t)) return "00:00";
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60);
  return String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
};

const audio = document.getElementById("audio");
const playBtn = document.getElementById("play-btn");
const volBtn = document.getElementById("vol-btn");
const nextBtn = document.getElementById("next-btn");
const shuffleBtn = document.getElementById("shuffle-btn");
const trackListEl = document.getElementById("track-list");
const currentTitle = document.getElementById("current-title");
const currentArt = document.getElementById("current-art");
const progFill = document.getElementById("progress-fill");
const timeCurEl = document.getElementById("time-current");
const timeTotEl = document.getElementById("time-total");
const gelmLogo = document.getElementById("logo-mini");

let tracks = [];
let currentIndex = -1;
let userEverPlayed = false;
let shuffleMode = true;

fetch("musica.json")
  .then(r => r.json())
  .then(data => {
    tracks = data.map((t,i)=>({
      url: t.url,
      title: (t.title || t.nombre || ("Pista "+(i+1))).trim()
    }));
    renderTrackList();

    if (shuffleMode) currentIndex = getRandomIndex();
    else currentIndex = 0;

    setCurrentTrack(currentIndex, false);
  });

function renderTrackList(){
  trackListEl.innerHTML = "";
  tracks.forEach((t,i)=>{
    const row = document.createElement("div");
    row.className="track-item";
    row.dataset.index=i;

    row.innerHTML = `
      <div class="track-thumb">
        <img src="icons/icon-512.png">
      </div>
      <div class="track-info">${t.title}</div>
    `;

    row.addEventListener("click",()=>{
      setCurrentTrack(i,true);
    });

    trackListEl.appendChild(row);
  });
  updateActiveRow();
}

function updateActiveRow(){
  const rows = trackListEl.querySelectorAll(".track-item");
  rows.forEach(r=>r.classList.remove("active"));
  if(rows[currentIndex]) rows[currentIndex].classList.add("active");
}

function getRandomIndex(){
  if(tracks.length <= 1) return 0;
  let r = currentIndex;
  while(r === currentIndex) r = Math.floor(Math.random()*tracks.length);
  return r;
}

function setCurrentTrack(i, autoplay){
  currentIndex = (i + tracks.length) % tracks.length;

  const track = tracks[currentIndex];
  audio.src = track.url;
  currentTitle.textContent = track.title;

  updateActiveRow();

  if(autoplay){
    audio.play();
    userEverPlayed = true;
    playBtn.textContent = "â¸";
  } else {
    playBtn.textContent = "â–¶";
  }
}

playBtn.addEventListener("click",()=>{
  if(audio.paused){
    audio.play();
    playBtn.textContent="â¸";
  } else {
    audio.pause();
    playBtn.textContent="â–¶";
  }
});

// LOGO PULSO â€” EFECTO A
audio.addEventListener("play", ()=>{
  gelmLogo.classList.add("logo-pulse");
});
audio.addEventListener("pause", ()=>{
  gelmLogo.classList.remove("logo-pulse");
});

nextBtn.addEventListener("click",()=>{
  if(shuffleMode) setCurrentTrack(getRandomIndex(),true);
  else setCurrentTrack(currentIndex+1,true);
});

shuffleBtn.addEventListener("click",()=>{
  shuffleMode = !shuffleMode;
  shuffleBtn.classList.toggle("active");
  shuffleBtn.textContent = shuffleMode ? "ðŸ”€" : "âž¡ï¸";
});

volBtn.addEventListener("click",()=>{
  audio.muted = !audio.muted;
  volBtn.textContent = audio.muted ? "ðŸ”ˆ" : "ðŸ”Š";
});

audio.addEventListener("ended",()=>{
  if(shuffleMode) setCurrentTrack(getRandomIndex(),true);
  else setCurrentTrack(currentIndex+1,true);
});

audio.addEventListener("timeupdate",()=>{
  if(!audio.duration) return;
  progFill.style.width = (audio.currentTime / audio.duration) * 100 + "%";
  timeCurEl.textContent = fmt(audio.currentTime);
  timeTotEl.textContent = fmt(audio.duration);
});

audio.addEventListener("loadedmetadata",()=>{
  timeTotEl.textContent = fmt(audio.duration);
  timeCurEl.textContent = "00:00";
  progFill.style.width = "0%";
});

document.querySelector(".progress-bar")
  .addEventListener("click",e=>{
    const box = e.currentTarget.getBoundingClientRect();
    const pct = (e.clientX - box.left) / box.width;
    audio.currentTime = pct * audio.duration;
  });

// OCULTAR SPLASH
document.addEventListener("DOMContentLoaded", () => {
  setTimeout(() => {
    document.getElementById("splash").classList.add("splash-hide");
  }, 800);
});

// SERVICE WORKER
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
